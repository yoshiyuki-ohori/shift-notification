<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>配置状況ダッシュボード</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #f0f2f5; color: #1a1a2e; line-height: 1.5; }

  /* Header */
  .header { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
  .header h1 { font-size: 18px; font-weight: 600; white-space: nowrap; }
  .month-nav { display: flex; align-items: center; gap: 8px; }
  .month-nav button { background: rgba(255,255,255,0.15); border: none; color: #fff; width: 36px; height: 36px; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background 0.2s; }
  .month-nav button:hover { background: rgba(255,255,255,0.3); }
  .month-nav .current-month { font-size: 16px; font-weight: 600; min-width: 100px; text-align: center; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  .header-right button { background: #4ECDC4; border: none; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 600; }
  .header-right button:hover { background: #3dbdb5; }

  /* Auth overlay */
  .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
  .auth-box { background: #fff; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; text-align: center; }
  .auth-box h2 { font-size: 20px; margin-bottom: 8px; }
  .auth-box p { color: #666; font-size: 14px; margin-bottom: 20px; }
  .auth-box input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
  .auth-box input:focus { border-color: #4ECDC4; outline: none; }
  .auth-box button { width: 100%; padding: 12px; background: #1a1a2e; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
  .auth-box .error { color: #FF6B6B; font-size: 13px; margin-bottom: 8px; }

  /* Summary cards */
  .summary { display: flex; gap: 16px; padding: 20px 24px; flex-wrap: wrap; }
  .summary-card { background: #fff; border-radius: 12px; padding: 16px 24px; flex: 1; min-width: 150px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .summary-card .label { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; }
  .summary-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .summary-card:nth-child(1) .value { color: #1a1a2e; }
  .summary-card:nth-child(2) .value { color: #4ECDC4; }
  .summary-card:nth-child(3) .value { color: #FFD93D; }

  /* Main content */
  .content { padding: 0 24px 24px; }

  /* Facility card */
  .facility-card { background: #fff; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
  .facility-header { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; user-select: none; }
  .facility-header:hover { background: #f8f9fa; }
  .facility-toggle { font-size: 12px; color: #999; transition: transform 0.2s; }
  .facility-card.open .facility-toggle { transform: rotate(90deg); }
  .facility-name { font-size: 16px; font-weight: 700; }
  .facility-area { font-size: 12px; color: #fff; background: #1a1a2e; padding: 2px 8px; border-radius: 4px; }
  .facility-stats { margin-left: auto; display: flex; gap: 16px; font-size: 13px; color: #888; }
  .facility-stats span { white-space: nowrap; }

  /* Date grid */
  .facility-body { display: none; border-top: 1px solid #eee; }
  .facility-card.open .facility-body { display: block; }
  .date-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1px; background: #eee; padding: 1px; }
  .date-cell { background: #fff; padding: 8px 10px; min-height: 60px; }
  .date-cell.weekend { background: #fafafa; }
  .date-cell.sunday { background: #fff5f5; }
  .date-label { font-size: 12px; font-weight: 700; color: #333; margin-bottom: 4px; }
  .date-label.sunday { color: #FF6B6B; }
  .date-label.saturday { color: #4ECDC4; }
  .date-cell.empty { background: #f8f8f8; }

  /* Shift chips */
  .shift-chip { display: inline-block; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin: 1px 0; white-space: nowrap; }
  .shift-chip.morning { background: #e0f7f5; color: #2a9d8f; }
  .shift-chip.daytime { background: #fff8e1; color: #b8860b; }
  .shift-chip.evening { background: #ffe0e0; color: #c0392b; }
  .shift-chip.night   { background: #ede0f5; color: #6a3d9a; }

  /* Loading / Error */
  .loading { text-align: center; padding: 60px; color: #888; }
  .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #eee; border-top-color: #4ECDC4; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-msg { text-align: center; padding: 40px; color: #FF6B6B; }

  /* Responsive */
  @media (max-width: 768px) {
    .header { padding: 12px 16px; }
    .summary { padding: 16px; gap: 8px; }
    .summary-card { padding: 12px 16px; }
    .summary-card .value { font-size: 22px; }
    .content { padding: 0 16px 16px; }
    .date-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
    .facility-stats { display: none; }
  }
</style>
</head>
<body>

<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>管理者ログイン</h2>
    <p>APIキーを入力してください</p>
    <div class="error" id="authError"></div>
    <input type="password" id="apiKeyInput" placeholder="ADMIN_API_KEY" autocomplete="off">
    <button onclick="submitApiKey()">ログイン</button>
  </div>
</div>

<div class="header">
  <h1>配置状況ダッシュボード</h1>
  <div class="month-nav">
    <button onclick="changeMonth(-1)" title="前月">&#9664;</button>
    <span class="current-month" id="currentMonth"></span>
    <button onclick="changeMonth(1)" title="翌月">&#9654;</button>
  </div>
  <div class="header-right">
    <button onclick="loadData()">再読み込み</button>
  </div>
</div>

<div class="summary" id="summary" style="display:none;">
  <div class="summary-card">
    <div class="label">施設数</div>
    <div class="value" id="sumFacilities">-</div>
  </div>
  <div class="summary-card">
    <div class="label">総シフト数</div>
    <div class="value" id="sumShifts">-</div>
  </div>
  <div class="summary-card">
    <div class="label">配置人数</div>
    <div class="value" id="sumStaff">-</div>
  </div>
</div>

<div class="content" id="content">
  <div class="loading" id="loadingMsg" style="display:none;">
    <div class="spinner"></div>
    <p style="margin-top:12px;">読み込み中...</p>
  </div>
</div>

<script>
(function() {
  // --- Config ---
  var GAS_URL = '';  // Set at runtime from URL params or stored value
  var API_KEY = '';
  var currentYear, currentMonth;

  // --- Init ---
  function init() {
    // Read URL params
    var params = new URLSearchParams(location.search);
    API_KEY = params.get('key') || localStorage.getItem('admin_api_key') || '';
    GAS_URL = params.get('gas_url') || localStorage.getItem('admin_gas_url') || '';

    // Parse month param
    var monthParam = params.get('month') || '';
    if (monthParam && /^\d{4}-\d{2}$/.test(monthParam)) {
      currentYear = parseInt(monthParam.split('-')[0], 10);
      currentMonth = parseInt(monthParam.split('-')[1], 10);
    } else {
      var now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth() + 1;
    }

    updateMonthDisplay();

    if (!API_KEY || !GAS_URL) {
      showAuth();
    } else {
      hideAuth();
      loadData();
    }
  }

  // --- Auth ---
  function showAuth() {
    var overlay = document.getElementById('authOverlay');
    overlay.style.display = 'flex';
    // Pre-fill known values
    if (GAS_URL) {
      document.getElementById('apiKeyInput').placeholder = 'ADMIN_API_KEY';
    }
    // If no GAS_URL, show both fields
    if (!GAS_URL) {
      var box = overlay.querySelector('.auth-box');
      if (!document.getElementById('gasUrlInput')) {
        var urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.id = 'gasUrlInput';
        urlInput.placeholder = 'GAS WebApp URL (https://script.google.com/...)';
        box.insertBefore(urlInput, box.querySelector('button'));
      }
    }
  }

  function hideAuth() {
    document.getElementById('authOverlay').style.display = 'none';
  }

  window.submitApiKey = function() {
    var key = document.getElementById('apiKeyInput').value.trim();
    var urlInput = document.getElementById('gasUrlInput');
    var url = urlInput ? urlInput.value.trim() : GAS_URL;

    if (!key) {
      document.getElementById('authError').textContent = 'APIキーを入力してください';
      return;
    }
    if (!url) {
      document.getElementById('authError').textContent = 'GAS URLを入力してください';
      return;
    }

    API_KEY = key;
    GAS_URL = url;
    localStorage.setItem('admin_api_key', API_KEY);
    localStorage.setItem('admin_gas_url', GAS_URL);
    hideAuth();
    loadData();
  };

  // --- Month Navigation ---
  function updateMonthDisplay() {
    var mm = ('0' + currentMonth).slice(-2);
    document.getElementById('currentMonth').textContent = currentYear + '年' + currentMonth + '月';
    // Update URL without reload
    var url = new URL(location.href);
    url.searchParams.set('month', currentYear + '-' + mm);
    history.replaceState(null, '', url);
  }

  window.changeMonth = function(delta) {
    currentMonth += delta;
    if (currentMonth > 12) { currentMonth = 1; currentYear++; }
    if (currentMonth < 1) { currentMonth = 12; currentYear--; }
    updateMonthDisplay();
    loadData();
  };

  // --- Data Loading ---
  window.loadData = function() {
    var content = document.getElementById('content');
    var summary = document.getElementById('summary');

    // Create loading element fresh each time (innerHTML destroys previous)
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px;">読み込み中...</p></div>';
    summary.style.display = 'none';

    var mm = ('0' + currentMonth).slice(-2);
    var targetMonth = currentYear + '-' + mm;

    var url = GAS_URL + '?action=facilityOverview&key=' + encodeURIComponent(API_KEY) + '&month=' + encodeURIComponent(targetMonth);

    console.log('[Admin] Fetching:', url);
    fetch(url, { redirect: 'follow' })
      .then(function(res) {
        console.log('[Admin] Response status:', res.status, 'url:', res.url);
        return res.text();
      })
      .then(function(text) {
        console.log('[Admin] Response length:', text.length, 'bytes');
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error('[Admin] JSON parse error. First 500 chars:', text.substring(0, 500));
          throw new Error('JSONパース失敗: ' + text.substring(0, 200));
        }
      })
      .then(function(data) {
        console.log('[Admin] Parsed data:', {
          facilities: data.facilities ? data.facilities.length : 0,
          summary: data.summary,
          error: data.error
        });
        if (data.error) {
          if (data.error === 'Unauthorized') {
            localStorage.removeItem('admin_api_key');
            showAuth();
            document.getElementById('authError').textContent = 'APIキーが無効です';
            return;
          }
          content.innerHTML = '<div class="error-msg">エラー: ' + escapeHtml(data.error) + '</div>';
          return;
        }
        renderDashboard(data);
      })
      .catch(function(err) {
        console.error('[Admin] Fetch error:', err);
        content.innerHTML = '<div class="error-msg">通信エラー: ' + escapeHtml(err.message || String(err)) + '</div>';
      });
  };

  // --- Rendering ---
  function renderDashboard(data) {
    var summary = document.getElementById('summary');
    summary.style.display = 'flex';
    document.getElementById('sumFacilities').textContent = data.summary.totalFacilities;
    document.getElementById('sumShifts').textContent = data.summary.totalShifts;
    document.getElementById('sumStaff').textContent = data.summary.totalStaff;

    var content = document.getElementById('content');
    content.innerHTML = '';

    if (data.facilities.length === 0) {
      content.innerHTML = '<div class="loading"><p>この月のシフトデータはありません</p></div>';
      return;
    }

    // Get days in month
    var parts = data.targetMonth.split('-');
    var year = parseInt(parts[0], 10);
    var month = parseInt(parts[1], 10);
    var daysInMonth = new Date(year, month, 0).getDate();

    // 夜勤マージ適用 & stats再計算
    var totalShiftsMerged = 0;
    for (var i = 0; i < data.facilities.length; i++) {
      var fac = data.facilities[i];
      fac.dates = mergeOvernightShifts(fac.dates || {});
      // stats再計算
      var facShifts = 0;
      var staffSet = {};
      var dayKeys = Object.keys(fac.dates);
      for (var di = 0; di < dayKeys.length; di++) {
        var arr = fac.dates[dayKeys[di]];
        facShifts += arr.length;
        for (var si = 0; si < arr.length; si++) {
          if (arr[si].empNo) staffSet[arr[si].empNo] = true;
        }
      }
      fac.stats = { totalShifts: facShifts, uniqueStaff: Object.keys(staffSet).length };
      totalShiftsMerged += facShifts;
    }
    document.getElementById('sumShifts').textContent = totalShiftsMerged;

    console.log('[Admin] Rendering', data.facilities.length, 'facilities for', year + '-' + month);
    for (var i = 0; i < data.facilities.length; i++) {
      try {
        content.appendChild(createFacilityCard(data.facilities[i], year, month, daysInMonth));
      } catch (e) {
        console.error('[Admin] Error rendering facility', i, data.facilities[i].name, e);
      }
    }
    console.log('[Admin] Rendered', content.children.length, 'facility cards');
  }

  function createFacilityCard(facility, year, month, daysInMonth) {
    var card = document.createElement('div');
    card.className = 'facility-card';

    // Header
    var header = document.createElement('div');
    header.className = 'facility-header';
    header.innerHTML =
      '<span class="facility-toggle">&#9654;</span>' +
      '<span class="facility-name">' + escapeHtml(facility.name) + '</span>' +
      (facility.area ? '<span class="facility-area">' + escapeHtml(facility.area) + '</span>' : '') +
      '<div class="facility-stats">' +
        '<span>シフト: <b>' + facility.stats.totalShifts + '</b></span>' +
        '<span>スタッフ: <b>' + facility.stats.uniqueStaff + '</b></span>' +
      '</div>';

    header.addEventListener('click', function() {
      card.classList.toggle('open');
    });
    card.appendChild(header);

    // Body - date grid
    var body = document.createElement('div');
    body.className = 'facility-body';

    var grid = document.createElement('div');
    grid.className = 'date-grid';

    for (var d = 1; d <= daysInMonth; d++) {
      var cell = document.createElement('div');
      cell.className = 'date-cell';

      var dateObj = new Date(year, month - 1, d);
      var dow = dateObj.getDay();
      var dowLabels = ['日', '月', '火', '水', '木', '金', '土'];
      var labelClass = '';
      if (dow === 0) { cell.classList.add('sunday'); labelClass = ' sunday'; }
      if (dow === 6) { cell.classList.add('weekend'); labelClass = ' saturday'; }

      var label = document.createElement('div');
      label.className = 'date-label' + labelClass;
      label.textContent = d + ' (' + dowLabels[dow] + ')';
      cell.appendChild(label);

      var dayStr = String(d);
      var shifts = facility.dates[dayStr] || [];
      if (shifts.length === 0) {
        cell.classList.add('empty');
      }
      for (var s = 0; s < shifts.length; s++) {
        var chip = document.createElement('div');
        chip.className = 'shift-chip ' + getTimeSlotClass(shifts[s].timeSlot);
        chip.textContent = shifts[s].timeSlot + ' ' + shifts[s].name;
        chip.title = shifts[s].empNo + ' ' + shifts[s].name;
        cell.appendChild(chip);
      }

      grid.appendChild(cell);
    }

    body.appendChild(grid);
    card.appendChild(body);

    return card;
  }

  function getTimeSlotClass(timeSlot) {
    if (/^\d{1,2}-\d{1,2}時$/.test(timeSlot)) return 'night';  // 17-9時 (夜勤統合)
    if (timeSlot.indexOf('6') === 0) return 'morning';
    if (timeSlot.indexOf('9') === 0) return 'daytime';
    if (timeSlot.indexOf('17') === 0 || timeSlot.indexOf('16') === 0) return 'evening';
    if (timeSlot.indexOf('22') === 0) return 'night';
    return 'daytime';
  }

  // --- 夜勤マージ ---
  // 同一スタッフの 17時～22時 + 22時～ + 翌6時～9時 → 入りの日に「17-9時」1行
  function mergeOvernightShifts(dates) {
    var dayNums = Object.keys(dates).map(Number).sort(function(a, b) { return a - b; });
    var toRemove = {};  // "day_empNo_timeSlot" -> true

    for (var i = 0; i < dayNums.length; i++) {
      var day = dayNums[i];
      var shifts = dates[String(day)] || [];
      var nextDay = day + 1;
      var nextShifts = dates[String(nextDay)] || [];

      for (var s = 0; s < shifts.length; s++) {
        var ev = shifts[s];
        if (!ev.empNo || !/^\d{1,2}時～22時$/.test(ev.timeSlot)) continue;

        var emp = ev.empNo;
        // 同日の「22時～」
        var lateNight = null;
        for (var j = 0; j < shifts.length; j++) {
          if (shifts[j].empNo === emp && /^22時～$/.test(shifts[j].timeSlot)) { lateNight = shifts[j]; break; }
        }
        // 翌日の「6時～N時」
        var morning = null;
        for (var k = 0; k < nextShifts.length; k++) {
          if (nextShifts[k].empNo === emp && /^6時～\d{1,2}時$/.test(nextShifts[k].timeSlot)) { morning = nextShifts[k]; break; }
        }

        if (lateNight || morning) {
          var startMatch = ev.timeSlot.match(/^(\d{1,2})時/);
          var startH = startMatch ? startMatch[1] : '17';
          var endH = '翌';
          if (morning) {
            var endMatch = morning.timeSlot.match(/～(\d{1,2})時/);
            endH = endMatch ? endMatch[1] : '9';
          }
          ev.timeSlot = morning ? (startH + '-' + endH + '時') : (startH + '時～翌');
          if (lateNight) toRemove[day + '_' + emp + '_' + lateNight.timeSlot] = true;
          if (morning)   toRemove[nextDay + '_' + emp + '_' + morning.timeSlot] = true;
        }
      }
    }

    // 削除対象を除去
    for (var di = 0; di < dayNums.length; di++) {
      var d = dayNums[di];
      var key = String(d);
      if (!dates[key]) continue;
      dates[key] = dates[key].filter(function(s) {
        return !toRemove[d + '_' + s.empNo + '_' + s.timeSlot];
      });
      if (dates[key].length === 0) delete dates[key];
    }
    return dates;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  // --- Start ---
  init();
})();
</script>
</body>
</html>
