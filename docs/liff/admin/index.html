<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>配置状況ダッシュボード</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #f0f2f5; color: #1a1a2e; line-height: 1.5; }

  /* Header */
  .header { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
  .header h1 { font-size: 18px; font-weight: 600; white-space: nowrap; }
  .month-nav { display: flex; align-items: center; gap: 8px; }
  .month-nav button { background: rgba(255,255,255,0.15); border: none; color: #fff; width: 36px; height: 36px; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background 0.2s; }
  .month-nav button:hover { background: rgba(255,255,255,0.3); }
  .month-nav .current-month { font-size: 16px; font-weight: 600; min-width: 100px; text-align: center; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  .header-right button { background: #4ECDC4; border: none; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 600; }
  .header-right button:hover { background: #3dbdb5; }

  /* Auth overlay */
  .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
  .auth-box { background: #fff; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; text-align: center; }
  .auth-box h2 { font-size: 20px; margin-bottom: 8px; }
  .auth-box p { color: #666; font-size: 14px; margin-bottom: 20px; }
  .auth-box input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
  .auth-box input:focus { border-color: #4ECDC4; outline: none; }
  .auth-box button { width: 100%; padding: 12px; background: #1a1a2e; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
  .auth-box .error { color: #FF6B6B; font-size: 13px; margin-bottom: 8px; }

  /* Tabs */
  .tab-bar { display: flex; background: #fff; border-bottom: 2px solid #eee; padding: 0 24px; gap: 0; }
  .tab-btn { padding: 12px 20px; font-size: 14px; font-weight: 600; color: #888; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn:hover { color: #1a1a2e; }
  .tab-btn.active { color: #1a1a2e; border-bottom-color: #4ECDC4; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Summary cards */
  .summary { display: flex; gap: 16px; padding: 20px 24px; flex-wrap: wrap; }
  .summary-card { background: #fff; border-radius: 12px; padding: 16px 24px; flex: 1; min-width: 150px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .summary-card .label { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; }
  .summary-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .summary-card:nth-child(1) .value { color: #1a1a2e; }
  .summary-card:nth-child(2) .value { color: #4ECDC4; }
  .summary-card:nth-child(3) .value { color: #FFD93D; }

  /* Summary card colors for compliance/staffing */
  .summary-card .value.red { color: #FF6B6B; }
  .summary-card .value.yellow { color: #FFD93D; }
  .summary-card .value.green { color: #4ECDC4; }
  .summary-card .value.blue { color: #1a1a2e; }

  /* Main content */
  .content { padding: 0 24px 24px; }

  /* Facility card */
  .facility-card { background: #fff; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
  .facility-header { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; user-select: none; }
  .facility-header:hover { background: #f8f9fa; }
  .facility-toggle { font-size: 12px; color: #999; transition: transform 0.2s; }
  .facility-card.open .facility-toggle { transform: rotate(90deg); }
  .facility-name { font-size: 16px; font-weight: 700; }
  .facility-area { font-size: 12px; color: #fff; background: #1a1a2e; padding: 2px 8px; border-radius: 4px; }
  .facility-stats { margin-left: auto; display: flex; gap: 16px; font-size: 13px; color: #888; }
  .facility-stats span { white-space: nowrap; }

  /* Date grid */
  .facility-body { display: none; border-top: 1px solid #eee; }
  .facility-card.open .facility-body { display: block; }
  .date-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1px; background: #eee; padding: 1px; }
  .date-cell { background: #fff; padding: 8px 10px; min-height: 60px; }
  .date-cell.weekend { background: #fafafa; }
  .date-cell.sunday { background: #fff5f5; }
  .date-label { font-size: 12px; font-weight: 700; color: #333; margin-bottom: 4px; }
  .date-label.sunday { color: #FF6B6B; }
  .date-label.saturday { color: #4ECDC4; }
  .date-cell.empty { background: #f8f8f8; }

  /* Shift chips */
  .shift-chip { display: inline-block; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin: 1px 0; white-space: nowrap; border-left: 3px solid transparent; }
  .shift-chip.morning { color: #2a9d8f; }
  .shift-chip.daytime { color: #b8860b; }
  .shift-chip.evening { color: #c0392b; }
  .shift-chip.night   { color: #6a3d9a; }

  /* Alert cells (empty with data in month) - !important で日曜/土曜より優先 */
  .date-cell.alert { background: #fff0f0 !important; border-left: 3px solid #FF6B6B; }
  .date-cell.alert .empty-label { font-size: 11px; color: #FF6B6B; font-weight: 600; }
  .facility-stats .unplaced-count { color: #FF6B6B; font-weight: 700; }

  /* Add shift button */
  .add-shift-btn { display: none; background: #4ECDC4; color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; margin-top: 4px; }
  .date-cell:hover .add-shift-btn { display: inline-block; }
  .date-cell.alert .add-shift-btn, .date-cell.empty .add-shift-btn { display: inline-block; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
  .modal-overlay.active { display: flex; }
  .modal-box { background: #fff; border-radius: 16px; padding: 24px; max-width: 440px; width: 92%; max-height: 90vh; overflow-y: auto; }
  .modal-box h3 { font-size: 17px; margin-bottom: 16px; }
  .modal-box label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 4px; margin-top: 12px; }
  .modal-box select, .modal-box input[type="text"] { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
  .modal-box select:focus, .modal-box input[type="text"]:focus { border-color: #4ECDC4; outline: none; }
  .modal-info { font-size: 13px; color: #888; background: #f8f8f8; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; }
  .modal-actions { display: flex; gap: 8px; margin-top: 20px; }
  .modal-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
  .btn-save { background: #4ECDC4; color: #fff; }
  .btn-save:hover { background: #3dbdb5; }
  .btn-save:disabled { background: #ccc; cursor: not-allowed; }
  .btn-cancel { background: #f0f0f0; color: #333; }
  .btn-cancel:hover { background: #e0e0e0; }

  /* Staff search dropdown */
  .staff-search-wrap { position: relative; }
  .staff-search-wrap input { margin-bottom: 0; }
  .staff-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #4ECDC4; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10; display: none; }
  .staff-dropdown.open { display: block; }
  .staff-dropdown .staff-item { padding: 8px 12px; cursor: pointer; font-size: 13px; }
  .staff-dropdown .staff-item:hover { background: #e0f7f5; }
  .staff-dropdown .staff-item .emp-no { color: #888; margin-left: 8px; font-size: 12px; }

  /* Toast */
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; z-index: 300; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; }

  /* Loading / Error */
  .loading { text-align: center; padding: 60px; color: #888; }
  .loading .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #eee; border-top-color: #4ECDC4; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-msg { text-align: center; padding: 40px; color: #FF6B6B; }

  /* Compliance list */
  .compliance-item { background: #fff; border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); display: flex; align-items: center; gap: 12px; }
  .compliance-item .badge { display: inline-block; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 6px; white-space: nowrap; }
  .badge.violation { background: #FFE0E0; color: #CC3333; }
  .badge.warning { background: #FFF3CD; color: #997700; }
  .compliance-item .ci-body { flex: 1; min-width: 0; }
  .compliance-item .ci-name { font-weight: 700; font-size: 14px; }
  .compliance-item .ci-detail { font-size: 13px; color: #555; margin-top: 2px; }
  .compliance-item .ci-dates { font-size: 12px; color: #999; margin-top: 2px; }
  .compliance-item .ci-type { font-size: 11px; color: #aaa; white-space: nowrap; }
  .filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
  .filter-bar select, .filter-bar input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; }
  .filter-bar select:focus, .filter-bar input:focus { border-color: #4ECDC4; outline: none; }

  /* Staffing heatmap */
  .area-summary-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
  .area-card { background: #fff; border-radius: 12px; padding: 16px 20px; flex: 1; min-width: 200px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .area-card h4 { font-size: 15px; font-weight: 700; margin-bottom: 8px; }
  .area-stat { display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0; }
  .area-stat .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
  .dot.red { background: #FF6B6B; }
  .dot.yellow { background: #FFD93D; }
  .dot.green { background: #4ECDC4; }
  .staffing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1px; background: #eee; padding: 1px; border-radius: 8px; overflow: hidden; }
  .staffing-cell { padding: 8px 10px; min-height: 48px; font-size: 12px; }
  .staffing-cell.shortage { background: #FFE0E0; }
  .staffing-cell.caution { background: #FFF8E1; }
  .staffing-cell.ok { background: #E8F5E9; }
  .staffing-cell .sc-label { font-weight: 700; margin-bottom: 2px; }
  .staffing-cell .sc-count { font-size: 13px; font-weight: 600; }

  /* Responsive */
  @media (max-width: 768px) {
    .header { padding: 12px 16px; }
    .summary { padding: 16px; gap: 8px; }
    .summary-card { padding: 12px 16px; }
    .summary-card .value { font-size: 22px; }
    .content { padding: 0 16px 16px; }
    .date-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
    .facility-stats { display: none; }
    .tab-bar { padding: 0 16px; }
    .tab-btn { padding: 10px 14px; font-size: 13px; }
  }
</style>
</head>
<body>

<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>管理者ログイン</h2>
    <p>APIキーを入力してください</p>
    <div class="error" id="authError"></div>
    <input type="password" id="apiKeyInput" placeholder="ADMIN_API_KEY" autocomplete="off">
    <button onclick="submitApiKey()">ログイン</button>
  </div>
</div>

<div class="header">
  <h1>配置状況ダッシュボード <span style="font-size:11px;opacity:0.5">v3.0</span></h1>
  <div class="month-nav">
    <button onclick="changeMonth(-1)" title="前月">&#9664;</button>
    <span class="current-month" id="currentMonth"></span>
    <button onclick="changeMonth(1)" title="翌月">&#9654;</button>
  </div>
  <div class="header-right">
    <button onclick="refreshCurrentTab()">再読み込み</button>
  </div>
</div>

<div class="tab-bar" id="tabBar">
  <button class="tab-btn active" data-tab="facility" onclick="switchTab('facility')">施設一覧</button>
  <button class="tab-btn" data-tab="compliance" onclick="switchTab('compliance')">労基チェック</button>
  <button class="tab-btn" data-tab="staffing" onclick="switchTab('staffing')">配置充足率</button>
</div>

<!-- Tab 1: Facility Overview (existing) -->
<div class="tab-content active" id="tab-facility">
  <div class="summary" id="summary" style="display:none;">
    <div class="summary-card">
      <div class="label">施設数</div>
      <div class="value" id="sumFacilities">-</div>
    </div>
    <div class="summary-card">
      <div class="label">総シフト数</div>
      <div class="value" id="sumShifts">-</div>
    </div>
    <div class="summary-card">
      <div class="label">配置人数</div>
      <div class="value" id="sumStaff">-</div>
    </div>
  </div>
  <div class="content" id="content">
    <div class="loading" id="loadingMsg" style="display:none;">
      <div class="spinner"></div>
      <p style="margin-top:12px;">読み込み中...</p>
    </div>
  </div>
</div>

<!-- Tab 2: Compliance Check -->
<div class="tab-content" id="tab-compliance">
  <div class="summary" id="complianceSummary" style="display:none;">
    <div class="summary-card">
      <div class="label">違反</div>
      <div class="value red" id="compViolations">-</div>
    </div>
    <div class="summary-card">
      <div class="label">警告</div>
      <div class="value yellow" id="compWarnings">-</div>
    </div>
    <div class="summary-card">
      <div class="label">チェック済み</div>
      <div class="value blue" id="compChecked">-</div>
    </div>
  </div>
  <div class="content" id="complianceContent">
    <div class="loading"><p>タブを選択してデータを読み込みます</p></div>
  </div>
</div>

<!-- Tab 3: Staffing Fill Rate -->
<div class="tab-content" id="tab-staffing">
  <div class="summary" id="staffingSummary" style="display:none;">
    <div class="summary-card">
      <div class="label">不足</div>
      <div class="value red" id="staffShortage">-</div>
    </div>
    <div class="summary-card">
      <div class="label">注意</div>
      <div class="value yellow" id="staffCaution">-</div>
    </div>
    <div class="summary-card">
      <div class="label">目標達成</div>
      <div class="value green" id="staffOk">-</div>
    </div>
  </div>
  <div class="content" id="staffingContent">
    <div class="loading"><p>タブを選択してデータを読み込みます</p></div>
  </div>
</div>

<!-- Shift Input Modal -->
<div class="modal-overlay" id="shiftModal">
  <div class="modal-box">
    <h3>シフト追加</h3>
    <div class="modal-info" id="modalInfo"></div>
    <label>時間帯</label>
    <select id="modalTimeSlot">
      <option value="夜勤(17-9時)">夜勤(17-9時)</option>
      <option value="6時～9時">6時～9時</option>
      <option value="9時～17時">9時～17時</option>
      <option value="17時～22時">17時～22時</option>
      <option value="22時～">22時～</option>
    </select>
    <label>職員</label>
    <div class="staff-search-wrap">
      <input type="text" id="staffSearchInput" placeholder="名前・社員番号で検索..." autocomplete="off">
      <div class="staff-dropdown" id="staffDropdown"></div>
    </div>
    <input type="hidden" id="selectedEmpNo">
    <input type="hidden" id="selectedEmpName">
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeShiftModal()">キャンセル</button>
      <button class="btn-save" id="btnSaveShift" onclick="saveShift()" disabled>保存</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  // --- Config ---
  var GAS_URL = '';
  var API_KEY = '';
  var currentYear, currentMonth;
  var staffList = [];
  var staffListLoaded = false;
  var modalFacility = null;
  var modalDate = null;
  var activeTab = 'facility';
  var tabDataLoaded = { facility: false, compliance: false, staffing: false };

  // --- Init ---
  function init() {
    var params = new URLSearchParams(location.search);
    API_KEY = params.get('key') || localStorage.getItem('admin_api_key') || '';
    GAS_URL = params.get('gas_url') || localStorage.getItem('admin_gas_url') || '';

    var monthParam = params.get('month') || '';
    if (monthParam && /^\d{4}-\d{2}$/.test(monthParam)) {
      currentYear = parseInt(monthParam.split('-')[0], 10);
      currentMonth = parseInt(monthParam.split('-')[1], 10);
    } else {
      var now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth() + 1;
    }

    // Tab from URL
    var tabParam = params.get('tab') || '';
    if (['facility','compliance','staffing'].indexOf(tabParam) >= 0) {
      activeTab = tabParam;
    }

    updateMonthDisplay();

    // TODO: ログイン機能は本番導入時に有効化する
    // if (!API_KEY || !GAS_URL) {
    //   showAuth();
    // } else {
      hideAuth();
      switchTab(activeTab);
      loadStaffList();
    // }
  }

  // --- Auth ---
  function showAuth() {
    var overlay = document.getElementById('authOverlay');
    overlay.style.display = 'flex';
    if (!GAS_URL) {
      var box = overlay.querySelector('.auth-box');
      if (!document.getElementById('gasUrlInput')) {
        var urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.id = 'gasUrlInput';
        urlInput.placeholder = 'GAS WebApp URL (https://script.google.com/...)';
        box.insertBefore(urlInput, box.querySelector('button'));
      }
    }
  }

  function hideAuth() {
    document.getElementById('authOverlay').style.display = 'none';
  }

  window.submitApiKey = function() {
    var key = document.getElementById('apiKeyInput').value.trim();
    var urlInput = document.getElementById('gasUrlInput');
    var url = urlInput ? urlInput.value.trim() : GAS_URL;
    if (!key) { document.getElementById('authError').textContent = 'APIキーを入力してください'; return; }
    if (!url) { document.getElementById('authError').textContent = 'GAS URLを入力してください'; return; }
    API_KEY = key;
    GAS_URL = url;
    localStorage.setItem('admin_api_key', API_KEY);
    localStorage.setItem('admin_gas_url', GAS_URL);
    hideAuth();
    switchTab(activeTab);
    loadStaffList();
  };

  // --- Tabs ---
  window.switchTab = function(tab) {
    activeTab = tab;
    // Update tab buttons
    var btns = document.querySelectorAll('.tab-btn');
    for (var i = 0; i < btns.length; i++) {
      btns[i].classList.toggle('active', btns[i].getAttribute('data-tab') === tab);
    }
    // Update tab contents
    var contents = document.querySelectorAll('.tab-content');
    for (var j = 0; j < contents.length; j++) {
      contents[j].classList.toggle('active', contents[j].id === 'tab-' + tab);
    }
    // Update URL
    var url = new URL(location.href);
    url.searchParams.set('tab', tab);
    history.replaceState(null, '', url);
    // Load data if needed
    if (!tabDataLoaded[tab]) {
      if (tab === 'facility') loadFacilityData();
      else if (tab === 'compliance') loadComplianceData();
      else if (tab === 'staffing') loadStaffingData();
    }
  };

  window.refreshCurrentTab = function() {
    tabDataLoaded[activeTab] = false;
    if (activeTab === 'facility') loadFacilityData();
    else if (activeTab === 'compliance') loadComplianceData();
    else if (activeTab === 'staffing') loadStaffingData();
  };

  // --- Month Navigation ---
  function updateMonthDisplay() {
    var mm = ('0' + currentMonth).slice(-2);
    document.getElementById('currentMonth').textContent = currentYear + '年' + currentMonth + '月';
    var url = new URL(location.href);
    url.searchParams.set('month', currentYear + '-' + mm);
    history.replaceState(null, '', url);
  }

  window.changeMonth = function(delta) {
    currentMonth += delta;
    if (currentMonth > 12) { currentMonth = 1; currentYear++; }
    if (currentMonth < 1) { currentMonth = 12; currentYear--; }
    updateMonthDisplay();
    tabDataLoaded = { facility: false, compliance: false, staffing: false };
    if (activeTab === 'facility') loadFacilityData();
    else if (activeTab === 'compliance') loadComplianceData();
    else if (activeTab === 'staffing') loadStaffingData();
  };

  // ========================================
  // Tab 1: Facility Overview (existing logic)
  // ========================================
  window.loadData = function() { loadFacilityData(); };

  function loadFacilityData() {
    var content = document.getElementById('content');
    var summary = document.getElementById('summary');
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px;">読み込み中...</p></div>';
    summary.style.display = 'none';

    var mm = ('0' + currentMonth).slice(-2);
    var targetMonth = currentYear + '-' + mm;
    var url = GAS_URL + '?action=facilityOverview&key=' + encodeURIComponent(API_KEY) + '&month=' + encodeURIComponent(targetMonth);

    fetch(url, { redirect: 'follow' })
      .then(function(res) { return res.text(); })
      .then(function(text) {
        try { return JSON.parse(text); }
        catch (e) { throw new Error('JSONパース失敗: ' + text.substring(0, 200)); }
      })
      .then(function(data) {
        if (data.error) {
          if (data.error === 'Unauthorized') { localStorage.removeItem('admin_api_key'); showAuth(); document.getElementById('authError').textContent = 'APIキーが無効です'; return; }
          content.innerHTML = '<div class="error-msg">エラー: ' + escapeHtml(data.error) + '</div>';
          return;
        }
        renderDashboard(data);
        tabDataLoaded.facility = true;
      })
      .catch(function(err) {
        content.innerHTML = '<div class="error-msg">通信エラー: ' + escapeHtml(err.message || String(err)) + '</div>';
      });
  }

  function renderDashboard(data) {
    var summary = document.getElementById('summary');
    summary.style.display = 'flex';
    document.getElementById('sumFacilities').textContent = data.summary.totalFacilities;
    document.getElementById('sumShifts').textContent = data.summary.totalShifts;
    document.getElementById('sumStaff').textContent = data.summary.totalStaff;

    var content = document.getElementById('content');
    content.innerHTML = '';

    if (data.facilities.length === 0) {
      content.innerHTML = '<div class="loading"><p>この月のシフトデータはありません</p></div>';
      return;
    }

    var parts = data.targetMonth.split('-');
    var year = parseInt(parts[0], 10);
    var month = parseInt(parts[1], 10);
    var daysInMonth = new Date(year, month, 0).getDate();

    var totalShiftsMerged = 0;
    for (var i = 0; i < data.facilities.length; i++) {
      var fac = data.facilities[i];
      fac.dates = mergeOvernightShifts(fac.dates || {});
      var facShifts = 0;
      var staffSet = {};
      var dayKeys = Object.keys(fac.dates);
      for (var di = 0; di < dayKeys.length; di++) {
        var arr = fac.dates[dayKeys[di]];
        facShifts += arr.length;
        for (var si = 0; si < arr.length; si++) { if (arr[si].empNo) staffSet[arr[si].empNo] = true; }
      }
      fac.stats = { totalShifts: facShifts, uniqueStaff: Object.keys(staffSet).length };
      totalShiftsMerged += facShifts;
    }
    document.getElementById('sumShifts').textContent = totalShiftsMerged;

    for (var i = 0; i < data.facilities.length; i++) {
      try { content.appendChild(createFacilityCard(data.facilities[i], year, month, daysInMonth)); }
      catch (e) { console.error('[Admin] Error rendering facility', i, e); }
    }
  }

  function createFacilityCard(facility, year, month, daysInMonth) {
    var card = document.createElement('div');
    card.className = 'facility-card';
    var hasAnyShift = facility.stats.totalShifts > 0;
    var unplacedDays = 0;
    if (hasAnyShift) {
      for (var dd = 1; dd <= daysInMonth; dd++) {
        if (!(facility.dates[String(dd)] && facility.dates[String(dd)].length > 0)) unplacedDays++;
      }
    }

    var header = document.createElement('div');
    header.className = 'facility-header';
    header.innerHTML =
      '<span class="facility-toggle">&#9654;</span>' +
      '<span class="facility-name">' + escapeHtml(facility.name) + '</span>' +
      (facility.area ? '<span class="facility-area">' + escapeHtml(facility.area) + '</span>' : '') +
      '<div class="facility-stats">' +
        '<span>シフト: <b>' + facility.stats.totalShifts + '</b></span>' +
        '<span>スタッフ: <b>' + facility.stats.uniqueStaff + '</b></span>' +
        (unplacedDays > 0 ? '<span class="unplaced-count">未配置: ' + unplacedDays + '日</span>' : '') +
      '</div>';
    header.addEventListener('click', function() { card.classList.toggle('open'); });
    card.appendChild(header);

    var body = document.createElement('div');
    body.className = 'facility-body';
    var grid = document.createElement('div');
    grid.className = 'date-grid';

    for (var d = 1; d <= daysInMonth; d++) {
      var cell = document.createElement('div');
      cell.className = 'date-cell';
      var dateObj = new Date(year, month - 1, d);
      var dow = dateObj.getDay();
      var dowLabels = ['日','月','火','水','木','金','土'];
      var labelClass = '';
      if (dow === 0) { cell.classList.add('sunday'); labelClass = ' sunday'; }
      if (dow === 6) { cell.classList.add('weekend'); labelClass = ' saturday'; }

      var label = document.createElement('div');
      label.className = 'date-label' + labelClass;
      label.textContent = d + ' (' + dowLabels[dow] + ')';
      cell.appendChild(label);

      var dayStr = String(d);
      var shifts = facility.dates[dayStr] || [];
      if (shifts.length === 0) {
        cell.classList.add('empty');
        if (hasAnyShift) {
          cell.classList.add('alert');
          var emptyLabel = document.createElement('div');
          emptyLabel.className = 'empty-label';
          emptyLabel.textContent = '未配置';
          cell.appendChild(emptyLabel);
        }
      }
      for (var s = 0; s < shifts.length; s++) {
        var chip = document.createElement('div');
        chip.className = 'shift-chip ' + getTimeSlotClass(shifts[s].timeSlot);
        chip.style.backgroundColor = getStaffColor(shifts[s].empNo);
        chip.textContent = shifts[s].timeSlot + ' ' + shifts[s].name;
        chip.title = shifts[s].empNo + ' ' + shifts[s].name;
        cell.appendChild(chip);
      }

      var addBtn = document.createElement('button');
      addBtn.className = 'add-shift-btn';
      addBtn.textContent = '+';
      addBtn.title = 'シフトを追加';
      (function(fac, yr, mo, day) {
        addBtn.addEventListener('click', function(e) { e.stopPropagation(); openShiftModal(fac, yr, mo, day); });
      })(facility, year, month, d);
      cell.appendChild(addBtn);
      grid.appendChild(cell);
    }

    body.appendChild(grid);
    card.appendChild(body);
    return card;
  }

  // ========================================
  // Tab 2: Compliance Check
  // ========================================
  function loadComplianceData() {
    var content = document.getElementById('complianceContent');
    var summary = document.getElementById('complianceSummary');
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px;">労基チェック実行中...</p></div>';
    summary.style.display = 'none';

    var mm = ('0' + currentMonth).slice(-2);
    var targetMonth = currentYear + '-' + mm;
    var url = GAS_URL + '?action=complianceCheck&key=' + encodeURIComponent(API_KEY) + '&month=' + encodeURIComponent(targetMonth);

    fetch(url, { redirect: 'follow' })
      .then(function(res) { return res.text(); })
      .then(function(text) {
        try { return JSON.parse(text); }
        catch (e) { throw new Error('JSONパース失敗'); }
      })
      .then(function(data) {
        if (data.error) {
          if (data.error === 'Unauthorized') { localStorage.removeItem('admin_api_key'); showAuth(); return; }
          content.innerHTML = '<div class="error-msg">エラー: ' + escapeHtml(data.error) + '</div>';
          return;
        }
        renderCompliance(data);
        tabDataLoaded.compliance = true;
      })
      .catch(function(err) {
        content.innerHTML = '<div class="error-msg">通信エラー: ' + escapeHtml(err.message || String(err)) + '</div>';
      });
  }

  function renderCompliance(data) {
    var summary = document.getElementById('complianceSummary');
    summary.style.display = 'flex';
    document.getElementById('compViolations').textContent = data.summary.totalViolations;
    document.getElementById('compWarnings').textContent = data.summary.totalWarnings;
    document.getElementById('compChecked').textContent = data.summary.checkedEmployees + '名';

    var content = document.getElementById('complianceContent');
    content.innerHTML = '';

    var allItems = [];
    if (data.violations) {
      for (var i = 0; i < data.violations.length; i++) allItems.push(data.violations[i]);
    }
    if (data.warnings) {
      for (var j = 0; j < data.warnings.length; j++) allItems.push(data.warnings[j]);
    }

    if (allItems.length === 0) {
      content.innerHTML = '<div class="loading"><p>問題は検出されませんでした</p></div>';
      return;
    }

    // Filter bar
    var filterBar = document.createElement('div');
    filterBar.className = 'filter-bar';

    var sevFilter = document.createElement('select');
    sevFilter.id = 'compSevFilter';
    sevFilter.innerHTML = '<option value="">全て</option><option value="violation">違反のみ</option><option value="warning">警告のみ</option>';
    filterBar.appendChild(sevFilter);

    var nameFilter = document.createElement('input');
    nameFilter.type = 'text';
    nameFilter.placeholder = '職員名で絞り込み...';
    nameFilter.id = 'compNameFilter';
    filterBar.appendChild(nameFilter);

    content.appendChild(filterBar);

    var listEl = document.createElement('div');
    listEl.id = 'complianceList';
    content.appendChild(listEl);

    function renderList() {
      var sev = document.getElementById('compSevFilter').value;
      var name = document.getElementById('compNameFilter').value.trim().toLowerCase();
      listEl.innerHTML = '';

      var filtered = allItems.filter(function(item) {
        if (sev && item.severity !== sev) return false;
        if (name && item.employeeName.toLowerCase().indexOf(name) < 0) return false;
        return true;
      });

      if (filtered.length === 0) {
        listEl.innerHTML = '<div class="loading"><p>該当する項目はありません</p></div>';
        return;
      }

      for (var k = 0; k < filtered.length; k++) {
        var item = filtered[k];
        var el = document.createElement('div');
        el.className = 'compliance-item';
        el.innerHTML =
          '<span class="badge ' + item.severity + '">' + (item.severity === 'violation' ? '違反' : '警告') + '</span>' +
          '<div class="ci-body">' +
            '<div class="ci-name">' + escapeHtml(item.employeeName) + ' <span style="color:#999;font-weight:400;font-size:12px">' + escapeHtml(item.employeeNo) + '</span></div>' +
            '<div class="ci-detail">' + escapeHtml(item.detail) + '</div>' +
            '<div class="ci-dates">' + escapeHtml((item.dates || []).join(', ')) + '</div>' +
          '</div>' +
          '<span class="ci-type">' + escapeHtml(item.type) + '</span>';
        listEl.appendChild(el);
      }
    }

    sevFilter.addEventListener('change', renderList);
    nameFilter.addEventListener('input', renderList);
    renderList();
  }

  // ========================================
  // Tab 3: Staffing Fill Rate
  // ========================================
  function loadStaffingData() {
    var content = document.getElementById('staffingContent');
    var summary = document.getElementById('staffingSummary');
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px;">配置充足率チェック中...</p></div>';
    summary.style.display = 'none';

    var mm = ('0' + currentMonth).slice(-2);
    var targetMonth = currentYear + '-' + mm;
    var url = GAS_URL + '?action=staffingCheck&key=' + encodeURIComponent(API_KEY) + '&month=' + encodeURIComponent(targetMonth);

    fetch(url, { redirect: 'follow' })
      .then(function(res) { return res.text(); })
      .then(function(text) {
        try { return JSON.parse(text); }
        catch (e) { throw new Error('JSONパース失敗'); }
      })
      .then(function(data) {
        if (data.error) {
          if (data.error === 'Unauthorized') { localStorage.removeItem('admin_api_key'); showAuth(); return; }
          content.innerHTML = '<div class="error-msg">エラー: ' + escapeHtml(data.error) + '</div>';
          return;
        }
        renderStaffing(data);
        tabDataLoaded.staffing = true;
      })
      .catch(function(err) {
        content.innerHTML = '<div class="error-msg">通信エラー: ' + escapeHtml(err.message || String(err)) + '</div>';
      });
  }

  function renderStaffing(data) {
    var content = document.getElementById('staffingContent');
    content.innerHTML = '';

    // Count totals
    var totalShortage = 0, totalCaution = 0, totalOk = 0;
    var areas = Object.keys(data.areaSummary || {});
    for (var a = 0; a < areas.length; a++) {
      var as = data.areaSummary[areas[a]];
      totalShortage += as.shortage;
      totalCaution += as.caution;
      totalOk += as.ok;
    }

    var summary = document.getElementById('staffingSummary');
    summary.style.display = 'flex';
    document.getElementById('staffShortage').textContent = totalShortage;
    document.getElementById('staffCaution').textContent = totalCaution;
    document.getElementById('staffOk').textContent = totalOk;

    if (areas.length === 0 && (!data.facilities || data.facilities.length === 0)) {
      content.innerHTML = '<div class="loading"><p>必要配置データがありません。「必要配置」シートにデータを登録してください。</p></div>';
      return;
    }

    // Area summary cards
    if (areas.length > 0) {
      var areaRow = document.createElement('div');
      areaRow.className = 'area-summary-row';
      for (var i = 0; i < areas.length; i++) {
        var areaName = areas[i];
        var as = data.areaSummary[areaName];
        var card = document.createElement('div');
        card.className = 'area-card';
        card.innerHTML =
          '<h4>' + escapeHtml(areaName) + 'エリア</h4>' +
          '<div class="area-stat"><span><span class="dot green"></span>目標達成</span><span><b>' + as.ok + '</b>件</span></div>' +
          '<div class="area-stat"><span><span class="dot yellow"></span>注意</span><span><b>' + as.caution + '</b>件</span></div>' +
          '<div class="area-stat"><span><span class="dot red"></span>不足</span><span><b>' + as.shortage + '</b>件</span></div>' +
          '<div class="area-stat" style="border-top:1px solid #eee;padding-top:6px;margin-top:4px"><span>平均充足率</span><span><b>' + as.avgFillRate + '%</b></span></div>';
        areaRow.appendChild(card);
      }
      content.appendChild(areaRow);
    }

    // Facility-grouped staffing grid (show only shortage/caution)
    var alerts = data.alerts || [];
    var facilitiesData = data.facilities || [];

    // Group by facility
    var facGroups = {};
    for (var f = 0; f < facilitiesData.length; f++) {
      var entry = facilitiesData[f];
      if (entry.status === 'ok') continue; // Only show issues
      var key = entry.facilityName || entry.facilityId;
      if (!facGroups[key]) facGroups[key] = [];
      facGroups[key].push(entry);
    }

    var facNames = Object.keys(facGroups).sort();
    if (facNames.length === 0) {
      var okMsg = document.createElement('div');
      okMsg.className = 'loading';
      okMsg.innerHTML = '<p>全ての施設・時間帯で目標を達成しています</p>';
      content.appendChild(okMsg);
      return;
    }

    for (var fi = 0; fi < facNames.length; fi++) {
      var fname = facNames[fi];
      var items = facGroups[fname];
      var facCard = document.createElement('div');
      facCard.className = 'facility-card';

      var facHeader = document.createElement('div');
      facHeader.className = 'facility-header';
      var shortageCount = items.filter(function(x) { return x.status === 'shortage'; }).length;
      var cautionCount = items.filter(function(x) { return x.status === 'caution'; }).length;
      facHeader.innerHTML =
        '<span class="facility-toggle">&#9654;</span>' +
        '<span class="facility-name">' + escapeHtml(fname) + '</span>' +
        '<div class="facility-stats">' +
          (shortageCount > 0 ? '<span class="unplaced-count">不足: ' + shortageCount + '件</span>' : '') +
          '<span>注意: ' + cautionCount + '件</span>' +
        '</div>';
      facHeader.addEventListener('click', function() { this.parentElement.classList.toggle('open'); });
      facCard.appendChild(facHeader);

      var facBody = document.createElement('div');
      facBody.className = 'facility-body';
      var grid = document.createElement('div');
      grid.className = 'staffing-grid';

      for (var gi = 0; gi < items.length; gi++) {
        var it = items[gi];
        var cell = document.createElement('div');
        cell.className = 'staffing-cell ' + it.status;
        var dateParts = (it.date || '').split('/');
        var shortDate = dateParts.length >= 3 ? parseInt(dateParts[1],10) + '/' + parseInt(dateParts[2],10) : it.date;
        cell.innerHTML =
          '<div class="sc-label">' + escapeHtml(shortDate) + ' ' + escapeHtml(it.timeSlot) + '</div>' +
          '<div class="sc-count">' + it.assigned + '/' + it.required + '名' +
          (it.target > it.required ? ' (目標' + it.target + ')' : '') + '</div>';
        grid.appendChild(cell);
      }

      facBody.appendChild(grid);
      facCard.appendChild(facBody);
      content.appendChild(facCard);
    }
  }

  // ========================================
  // Shared utilities
  // ========================================
  function getTimeSlotClass(timeSlot) {
    if (/^\d{1,2}-\d{1,2}時$/.test(timeSlot)) return 'night';
    if (timeSlot.indexOf('6') === 0) return 'morning';
    if (timeSlot.indexOf('9') === 0) return 'daytime';
    if (timeSlot.indexOf('22') === 0) return 'night';
    if (/^\d{1,2}時～翌/.test(timeSlot)) return 'night';
    if (timeSlot.indexOf('17') === 0 || timeSlot.indexOf('16') === 0) return 'evening';
    return 'daytime';
  }

  function getStaffColor(empNo) {
    var num = parseInt(empNo, 10) || 0;
    var hue = (num * 137.508) % 360;
    return 'hsl(' + Math.round(hue) + ', 60%, 82%)';
  }

  function mergeOvernightShifts(dates) {
    var dayNums = Object.keys(dates).map(Number).sort(function(a, b) { return a - b; });
    var toRemove = {};

    for (var i = 0; i < dayNums.length; i++) {
      var day = dayNums[i];
      var shifts = dates[String(day)] || [];
      var nextDay = day + 1;
      var nextShifts = dates[String(nextDay)] || [];

      for (var s = 0; s < shifts.length; s++) {
        var ev = shifts[s];
        if (!ev.empNo || !/^\d{1,2}時～22時$/.test(ev.timeSlot)) continue;
        var emp = ev.empNo;
        var lateNight = null;
        for (var j = 0; j < shifts.length; j++) {
          if (shifts[j].empNo === emp && /^22時～$/.test(shifts[j].timeSlot)) { lateNight = shifts[j]; break; }
        }
        var morning = null;
        for (var k = 0; k < nextShifts.length; k++) {
          if (nextShifts[k].empNo === emp && /^6時～\d{1,2}時$/.test(nextShifts[k].timeSlot)) { morning = nextShifts[k]; break; }
        }
        if (lateNight || morning) {
          var startMatch = ev.timeSlot.match(/^(\d{1,2})時/);
          var startH = startMatch ? startMatch[1] : '17';
          var endH = '9';
          if (morning) { var endMatch = morning.timeSlot.match(/～(\d{1,2})時/); endH = endMatch ? endMatch[1] : '9'; }
          ev.timeSlot = startH + '-' + endH + '時';
          if (lateNight) toRemove[day + '_' + emp + '_' + lateNight.timeSlot] = true;
          if (morning) toRemove[nextDay + '_' + emp + '_' + morning.timeSlot] = true;
        }
      }
    }

    for (var di = 0; di < dayNums.length; di++) {
      var d = dayNums[di];
      var key = String(d);
      if (!dates[key]) continue;
      dates[key] = dates[key].filter(function(s) { return !toRemove[d + '_' + s.empNo + '_' + s.timeSlot]; });
      if (dates[key].length === 0) delete dates[key];
    }
    return dates;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  // --- Staff List ---
  function loadStaffList() {
    if (staffListLoaded) return;
    var url = GAS_URL + '?action=read&sheet=' + encodeURIComponent('従業員マスタ') + '&key=' + encodeURIComponent(API_KEY);
    fetch(url, { redirect: 'follow' })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (!data.data || data.data.length < 2) return;
        staffList = [];
        for (var i = 1; i < data.data.length; i++) {
          var row = data.data[i];
          var empNo = String(row[0] || '').trim();
          var name = String(row[1] || '').trim();
          var kana = String(row[2] || '').trim();
          var status = String(row[3] || '').trim();
          if (!empNo || !name) continue;
          if (status && (status.indexOf('退職') >= 0 || status.indexOf('退社') >= 0)) continue;
          staffList.push({ empNo: empNo.padStart(3, '0'), name: name, kana: kana });
        }
        staffListLoaded = true;
      })
      .catch(function(err) { console.error('[Admin] Staff list load error:', err); });
  }

  // --- Shift Modal ---
  function openShiftModal(facility, year, month, day) {
    modalFacility = facility;
    var mm = ('0' + month).slice(-2);
    var dd = ('0' + day).slice(-2);
    modalDate = { year: year, month: month, day: day, yearMonth: year + '-' + mm, dateStr: year + '/' + mm + '/' + dd };
    document.getElementById('modalInfo').textContent = facility.name + ' / ' + year + '年' + month + '月' + day + '日';
    document.getElementById('modalTimeSlot').value = '夜勤(17-9時)';
    document.getElementById('staffSearchInput').value = '';
    document.getElementById('selectedEmpNo').value = '';
    document.getElementById('selectedEmpName').value = '';
    document.getElementById('staffDropdown').classList.remove('open');
    document.getElementById('btnSaveShift').disabled = true;
    document.getElementById('shiftModal').classList.add('active');
  }
  window.openShiftModal = openShiftModal;

  window.closeShiftModal = function() {
    document.getElementById('shiftModal').classList.remove('active');
    modalFacility = null;
    modalDate = null;
  };

  document.getElementById('shiftModal').addEventListener('click', function(e) {
    if (e.target === this) closeShiftModal();
  });

  var staffSearchInput = document.getElementById('staffSearchInput');
  var staffDropdown = document.getElementById('staffDropdown');

  staffSearchInput.addEventListener('input', function() {
    var query = this.value.trim().toLowerCase();
    if (!query) { staffDropdown.classList.remove('open'); return; }
    var filtered = staffList.filter(function(s) {
      return s.name.toLowerCase().indexOf(query) >= 0 || s.empNo.indexOf(query) >= 0 || s.kana.toLowerCase().indexOf(query) >= 0;
    }).slice(0, 20);
    if (filtered.length === 0) { staffDropdown.classList.remove('open'); return; }
    staffDropdown.innerHTML = '';
    for (var i = 0; i < filtered.length; i++) {
      var item = document.createElement('div');
      item.className = 'staff-item';
      item.innerHTML = escapeHtml(filtered[i].name) + '<span class="emp-no">' + escapeHtml(filtered[i].empNo) + '</span>';
      (function(staff) {
        item.addEventListener('click', function() {
          staffSearchInput.value = staff.name;
          document.getElementById('selectedEmpNo').value = staff.empNo;
          document.getElementById('selectedEmpName').value = staff.name;
          staffDropdown.classList.remove('open');
          updateSaveButton();
        });
      })(filtered[i]);
      staffDropdown.appendChild(item);
    }
    staffDropdown.classList.add('open');
  });

  staffSearchInput.addEventListener('focus', function() { if (this.value.trim()) this.dispatchEvent(new Event('input')); });
  document.addEventListener('click', function(e) { if (!e.target.closest('.staff-search-wrap')) staffDropdown.classList.remove('open'); });
  document.getElementById('modalTimeSlot').addEventListener('change', updateSaveButton);

  function updateSaveButton() {
    var ts = document.getElementById('modalTimeSlot').value;
    var emp = document.getElementById('selectedEmpNo').value;
    document.getElementById('btnSaveShift').disabled = !(ts && emp);
  }

  window.saveShift = function() {
    var timeSlot = document.getElementById('modalTimeSlot').value;
    var empNo = document.getElementById('selectedEmpNo').value;
    var empName = document.getElementById('selectedEmpName').value;
    if (!timeSlot || !empNo || !modalFacility || !modalDate) return;
    var btn = document.getElementById('btnSaveShift');
    btn.disabled = true;
    btn.textContent = '保存中...';
    var fac = modalFacility;
    var dt = modalDate;
    var rows = buildShiftRows(fac, dt, timeSlot, empNo, empName);
    var payload = { action: 'append', key: API_KEY, sheet: 'シフトデータ', data: rows };

    fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), redirect: 'follow' })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.error) throw new Error(data.error);
      closeShiftModal();
      showToast('シフトを追加しました');
      tabDataLoaded.facility = false;
      loadFacilityData();
    })
    .catch(function(err) { showToast('保存エラー: ' + (err.message || String(err))); })
    .finally(function() { btn.disabled = false; btn.textContent = '保存'; });
  };

  function buildShiftRows(fac, dt, timeSlot, empNo, empName) {
    var area = fac.area || '';
    var facName = fac.name || '';
    var facId = fac.facilityId || fac.facId || '';
    if (timeSlot === '夜勤(17-9時)') {
      var nextDate = new Date(dt.year, dt.month - 1, dt.day + 1);
      var nextYM = nextDate.getFullYear() + '-' + ('0' + (nextDate.getMonth() + 1)).slice(-2);
      var nextDateStr = nextDate.getFullYear() + '/' + ('0' + (nextDate.getMonth() + 1)).slice(-2) + '/' + ('0' + nextDate.getDate()).slice(-2);
      return [
        [dt.yearMonth, dt.dateStr, area, facName, facId, '17時～22時', empName, empNo, empName],
        [dt.yearMonth, dt.dateStr, area, facName, facId, '22時～', empName, empNo, empName],
        [nextYM, nextDateStr, area, facName, facId, '6時～9時', empName, empNo, empName]
      ];
    }
    return [[dt.yearMonth, dt.dateStr, area, facName, facId, timeSlot, empName, empNo, empName]];
  }

  function showToast(msg) {
    var toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(function() { toast.classList.remove('show'); }, 3000);
  }

  // --- Start ---
  init();
})();
</script>
</body>
</html>
